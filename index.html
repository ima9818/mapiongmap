<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mapion座標 → Googleマップ（ワンボタン）</title>
<style>
  body{ font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, sans-serif; margin:0; padding:16px; line-height:1.6; }
  h1{ font-size:20px; margin:0 0 10px; }
  textarea{ width:100%; box-sizing:border-box; font-size:16px; padding:10px; }
  button{ padding:12px 16px; font-size:16px; margin-top:10px; width:100%; cursor:pointer; }
  #out{ margin-top:12px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:18px; font-weight:700; }
  .msg{ color:#666; font-size:12px; margin-top:6px; }
</style>
</head>
<body>
<h1>Mapion座標 → Googleマップ</h1>
<p>MapionのURLを貼って、下のボタンを押すと<br><b>計算 → コピー → マイマップを開く</b> を一気に行います。Googleマップに結果を貼り付けてください。</p>

<textarea id="input" rows="3" placeholder="例）http://sasp.mapion.co.jp/cm/119isesaki/?nl=36/16/35.98&el=139/15/34.17&scl=1500"></textarea>
<button id="goBtn" onclick="go()">計算して結果をコピーして地図を開く</button>

<div id="out"></div>
<div class="msg">※ 測地系補正は Tokyo → WGS84（準拠式）／小数第6位に丸め</div>
<div class="msg">※ マイマップのバージョンアップには対応していません。</div><script>
/* ---- 設定 ---- */
const MYMAP_URL = 'https://www.google.com/maps/d/edit?mid=1bsmlEhct96yonZynraZzo3WGYrcriWs&usp=sharing;'// 先に開くマイマップ
const BURST_DELAY_MS = 250; // ほぼ同時にするための遅延（200〜400で調整可）

/* ---- 変換ユーティリティ ---- */
function dmsToDec(d,m,s){ return d + m/60 + s/3600; }
function round6(x){ return Math.round(x*1e6)/1e6; }
function tky2wgs(lat,lng){
  // TKY → WGS84（準拠式）
  const latW = lat - 0.00010695*lat + 0.000017464*lng + 0.0046017;
  const lngW = lng - 0.000046038*lat - 0.000083043*lng + 0.010040;
  return [latW,lngW];
}

/* ---- ワンボタン処理 ---- */
async function go(){
  const out = document.getElementById('out');
  out.textContent = '';
  let latlng = '';

  try{
    // 1) 計算
    const raw = document.getElementById('input').value.trim();
    if(!raw) throw new Error('URLが空です');

    const u = new URL(raw);
    const nl = u.searchParams.get('nl');
    const el = u.searchParams.get('el');
    if(!nl || !el) throw new Error('URLに nl / el が含まれていません');

    const ns = nl.split('/').map(v => parseFloat(v));
    const es = el.split('/').map(v => parseFloat(v));
    if(ns.length<3 || es.length<3 || ns.some(isNaN) || es.some(isNaN)){
      throw new Error('緯度/経度の形式（度/分/秒）が不正です');
    }

    const lat = dmsToDec(ns[0], ns[1], ns[2]);
    const lng = dmsToDec(es[0], es[1], es[2]);
    const [latW, lngW] = tky2wgs(lat, lng);
    latlng = `${round6(latW)},${round6(lngW)}`;

    // 2) コピー
    try{
      if(navigator.clipboard && window.isSecureContext){
        await navigator.clipboard.writeText(latlng);
      }else{
        // 非HTTPS等のフォールバック
        const ta = document.createElement('textarea');
        ta.value = latlng;
        document.body.appendChild(ta);
        ta.select(); ta.setSelectionRange(0, ta.value.length);
        document.execCommand('copy');
        document.body.removeChild(ta);
      }
    }catch(_){
      // クリップボード不可時は手動コピー
      window.prompt('コピーしてください', latlng);
    }

    out.textContent = latlng;

    // 3) マイマップを開く（新しいタブ/アプリ）
    //    window.open を使うことで、元タブのJSが止まらず 4) へ進める
    window.open(MYMAP_URL, '_blank');

    // 4) ほぼ同時に座標ピンを開く（UL優先 → Androidは必要に応じて geo:）
    const isAndroid = /Android/i.test(navigator.userAgent);
    const pinUL = `https://www.google.com/maps/search/?api=1&query=${latlng}`;

    setTimeout(()=>{
      const t = Date.now();
      // 同一タブ遷移：ユーザー操作直後扱いになりアプリへ移りやすい
      location.href = pinUL;

      if(isAndroid){
        // AndroidでWebに残る端末向けの保険（任意）
        setTimeout(()=>{
          if(Date.now()-t < 1100){
            location.href = `geo:${latlng}?q=${latlng}`;
          }
        }, 900);
      }
    }, BURST_DELAY_MS);

  }catch(e){
    out.textContent = 'エラー：' + e.message;
  }
}
</script>
</body>
</html>
